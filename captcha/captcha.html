<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Joel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style type="text/css">
    html,
    body {
      background: pink;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }

    #captcha-container {
      background: white;
      width: 390px;
      height: 300px;
    }
    /* Your style here... */

    #instruction {
      background: white;
      width: 390px;
      height: 20px;
      margin: none;
      padding: none;
      text-align: center;
    }
    #spinningImage{
      height: 150px;
      width: 150px;
    }
    #spinningDiv{
      display: flex;
      align-items: center;
      justify-content: center;
      padding-top: 50px;
    }
    #spinButton{
      position: fixed;
      bottom: 10px;
    }
    #spinButtonDiv{
      bottom: 10px;
      margin-left: 40%;
    }
    
    /* Define the spinning animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
                
            }
        }

        /* Apply the animation when the 'spin-active' class is present */
        /* You can set some difficulty by changing the spin acceleration */
        .spin-active {
            /* linear( STARTPOINT, NEXTSTEP Percent-in-animation, LASTSTEP )*/
            animation: spin 1s linear(0, 0.25 33%, 0.5 50%, 0.75 83%, 1) infinite; /* 1 seconds per spin, uneven speed faster on important bits, infinite loop */
        }

  </style>
</head>

<body>
  <div id="captcha-container">
    <!-- Add your CAPTCHA here: -->
    <div id="instruction">
        <b id="instructiontext" class="text">Orient the Image correctly</b>
    </div>
    <div id="spinningDiv">
        <img id="spinningImage" src="Test.png">
    </div>
    <div id="spinButtonDiv">
        <button id="spinButton">Stop image</button>
    </div>
  </div>

  <script type="text/javascript">
    (function(window, document){
      // This is how you tell the parent window that the CAPTCHA was successful.
      function captchaSuccess() {
        window.top.postMessage("success", '*');
      }

      // Your CAPTCHA code goes here, we've added a simple example below:
        // Get references to the image and the button
        const spinningImage = document.getElementById('spinningImage');
        const spinButton = document.getElementById('spinButton');
        var correctrotation = "leer";
        var Levelcounter = 0;
        //Start spinning immediatly
        spinningImage.classList.add('spin-active');

        // Add a click event listener to the button
        spinButton.addEventListener('click', () => {
            // Check if the image is currently spinning
            if (spinningImage.classList.contains('spin-active')) {
                // If it's spinning, stop it and capture its current orientation
                const computedStyle = window.getComputedStyle(spinningImage);
                const transformValue = computedStyle.getPropertyValue('transform');
                const tr = transformValue;

                // Remove the 'spin-active' class to stop the CSS animation
                spinningImage.classList.remove('spin-active');

                // Apply the captured transform value to the Image
                // This makes the image stop at its current rotated position
                spinningImage.style.transform = transformValue;

                //get if tranform value is between -90 to 90 Degrees
                //calculate degrees from rotation matrix 
                var values = tr.split('(')[1],
                    values = values.split(')')[0],
                    values = values.split(',');
                var a = values[0]; // cos(x)
                var b = values[1]; // sin(x)
                var angle = Math.round(Math.atan2(b, a) * (180/Math.PI));
                //angle gets degree value from 0 to 180 on the right side and -180 to 0 on the left

                //if no side was picked until now, the chosen position will be saved and is the wrong Answer. Skipped if a side was already picked
                if(angle <= 90 && angle >= -90 && correctrotation == "leer"){
                  correctrotation = "bottom";
                }
                else if(correctrotation == "leer"){
                  correctrotation = "top";
                }

                //check if the now correct answer get chosen. Skips if this is the first click. Narrower angles increase difficulty.
                if((angle <= 20 && angle >= 0 && correctrotation == "top") || (angle <= 0 && angle >= -20 && correctrotation == "top")){
                  Levelcounter += 1;
                  // when correct, reset answer, iterate to next image, at the moment max 3 levels, can be changed and more Images added. keep naming scheme.
                  if(Levelcounter <= 2){
                    correctrotation = "leer";
                    document.getElementById("spinningImage").src="Test"+Levelcounter+".png";
                    // add new text to Instruction after correct answer
                    document.getElementById("instructiontext").textContent="Orient the Image correctly "+Levelcounter+"/3"
                  }
                  else{
                    captchaSuccess();
                  }
                }
                if((angle >= 160 && angle <= 180 && correctrotation == "bottom") || (angle <= -180 && angle >= -160 && correctrotation == "bottom")){
                  Levelcounter += 1;
                  // when correct, reset answer, iterate to next image, at the moment max 3 levels, can be changed and more Images added. keep naming scheme.
                  if(Levelcounter <= 2){
                    correctrotation = "leer";
                    document.getElementById("spinningImage").src="Test"+Levelcounter+".png";
                    // add new text to Instruction after correct answer
                    document.getElementById("instructiontext").textContent="Orient the Image correctly "+Levelcounter+"/3"
                  }
                  else{
                    captchaSuccess();
                  }
                }
                

                // Update button text
                spinButton.textContent = 'Try again';
            } else {
                // Remove any previously applied inline transform style (ie rotation)
                spinningImage.style.transform = '';
                // Add the 'spin-active' class to start the CSS animation
                spinningImage.classList.add('spin-active');
                // Update button text
                spinButton.textContent = 'Stop image';
            }
        });

    })(window, document);
  </script>
</body>
</html>
